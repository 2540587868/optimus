package gen

const OptionTemplate = `// Code generated by optimus. DO NOT EDIT.
package {{.Package}}

import (
{{- range .Imports}}
	{{ . }}
{{- end }}
)

type {{.StructName}}Option func(*{{.StructName}})

// New{{.StructName}} creates a new {{.StructName}} with defaults and applies options.
func New{{.StructName}}(opts ...{{.StructName}}Option) (*{{.StructName}}, error) {
	c := &{{.StructName}}{
		{{- range .Fields }}
		{{- if .DefaultVal }}
		{{ .Name }}: {{ .DefaultVal }},
		{{- end }}
		{{- end }}
	}
	c.Apply(opts...)

	if v,ok:=interface{}(c).(interface{ Validate() error }); ok{
		if err:=v.Validate(); err != nil {
			return nil, err
		}
	}

	return c , nil
}

// Apply applies options to the config
func (c *{{.StructName}}) Apply(opts ...{{.StructName}}Option) {
	for _, opt := range opts {
		opt(c)
	}
}

{{ range .Fields }}
{{- range .Comments }}
{{ . }}
{{- end }}
{{- if .IsSlice }}
// {{ .Func }} appends values to {{ .Name }} slice.
func {{ .Func }}(v ...{{ .ParamType }}) {{ $.StructName }}Option {
	return func(c *{{ $.StructName }}) {
		c.{{ .Name }} = append(c.{{ .Name }}, v...)
	}
}
{{- else if .IsMap }}
// {{ .Func }} adds a key-value pair to {{ .Name }}.
func {{ .Func }}(k {{ .KeyType }}, v {{ .ValueType }}) {{ $.StructName }}Option {
	return func(c *{{ $.StructName }}) {
		if c.{{ .Name }} == nil {
			c.{{ .Name }} = make(map[{{ .KeyType }}]{{ .ValueType }})
		}
		c.{{ .Name }}[k] = v
	}
}
{{- else if .IsPointer }}
// {{ .Func }} sets the {{ .Name }} field.
// Note: Parameter is value type, assigned as pointer internally.
func {{ .Func }}(v {{ .ParamType }}) {{ $.StructName }}Option {
	return func(c *{{ $.StructName }}) {
		c.{{ .Name }} = &v
	}
}
{{- else }}
// {{ .Func }} sets the {{ .Name }} field.
func {{ .Func }}(v {{ .Type }}) {{ $.StructName }}Option {
	return func(c *{{ $.StructName }}) {
		c.{{ .Name }} = v
	}
}
{{- end }}
{{ end }}
`
